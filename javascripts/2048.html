<html>
<script type="text/javascript">
    Err = {};
    Err.Remoterr = {};
    Err.Remoterr.onerror = function (msg, errorfileurl, lineno) {
        var jsonstring, response, pageurl, cookies;
        // Get some user input
        pageurl = window.location.href;
        cookies = document.cookie;

        jsonstring = "{\"set\": {\"jserr\": " +
                "{\"msg\": \"" + msg + "\", " +
                "\"errorfileurl\": \"" + errorfileurl + "\", " +
                "\"pageurl\": \"" + pageurl + "\", " +
                "\"cookies\": \"" + cookies + "\", " +
                "\"lineno\": \"" + lineno + "\", " +
                "\"response\": \"" + response + "\"}}}";

        document.write(jsonstring);
        return false;
    };
    window.onerror = Err.Remoterr.onerror;
</script>
<body>
<script type="text/javascript">
var BGColor = new Object();
var score = 0;
BGColor[0] = '#888888';
BGColor[2] = '#BBBBBB';
BGColor[4] = '#FFFFCC';
BGColor[8] = '#FFCC66';
BGColor[16] = '#FF9966';
BGColor[32] = '#FF6600';
BGColor[64] = '#FF0000';
BGColor[128] = '#FFFF99';
BGColor[256] = '#FFFF66';
BGColor[512] = '#FFFF33';
BGColor[1024] = '#FFFF00';
BGColor[2048] = '#CCCC00';
BGColor[4096] = '#99CC00';
BGColor[8192] = '#333300';
BGColor[16384] = '#333300';

var empty,total, i, j, sec, prev, cur, pos, keyCode;
var easy = 1;
var size = 4;
var num = new Array();
for (i = 0; i < size * size; i++) num[i] = 0;
fillRandom();
var currentTime = +new Date();
//    document.write(num);
var invalid = 0;
display();

// invalid is 0 if last move was success,
// 1 if wrong keystroke was pressed
// and 2 if game is over.
function display() {
    document.open();

    document.write("<style>");
    document.write("body {background-color: #999999;}");
    document.write("table");
    document.write("{table-layout: fixed; width: 600; height: 500}");

    document.write(" tr {min-height: 400; } ");

    document.write(" td {");
    document.write("padding: 20px; min-height: 400; ");
    document.write("border: 10px solid #555555;");
    document.write("font: bold 30px Georgia, serif;}</style>");

    document.write("<table><tr><td width=600 style='border: 0px'>");
    document.write("<table>");
    for (i = 0; i < 4; i++) {
        document.write("<tr>");
        for (j = 0; j < 4; j++) {
            document.write("<td height=100 bgcolor=" + BGColor[num[4 * i + j]] + ">");
            if (num[4 * i + j] != 0)
                document.write(num[4 * i + j]);
            document.write("</td>");
        }
        document.write("</tr>");
    }
    document.write("</table></td>");
    document.write("<td width='100' valign='top' style='border: 0px;'>" + "Score: <br>" + score + "</strong></td>");
    document.write("</tr></table>");

    if (invalid == 1) {
        document.write("use arrow keys UP,DOWN,LEFT,RIGHT/WASD to play this game");
    }
    if (invalid == 2) {
        // tell that game is over, check highest scores
        sec = +new Date();
        document.write("you scored " + score + " in " + (sec - currentTime) / 1000 + " seconds");
    } else {
        document.getElementsByTagName('body')[0].onkeydown = function(event) {
            keyCode = event.keyCode;
            if (keyCode == 87) keyCode = 38;
            if (keyCode == 65) keyCode = 37;
            if (keyCode == 83) keyCode = 40;
            if (keyCode == 68) keyCode = 39;

            if ((keyCode > 36) && (keyCode < 41)) {
                makeMove(keyCode);
                if (fillRandom() == 1) {
                    invalid = 2;
                    display();
                } else {
                    invalid = 0;
                    display();
                }
            } else {
                invalid = 1;
                display();
            }
        }
    }
}

function makeMove(move) {
    switch (move) {
        case 37:  //left
            for (i = 0; i < size; i++) {
                prev = 0;
                cur = 0;
                pos = 0;
                for (j = 0; j < size; j++) {
                    if (num[size * i + j] != 0) {
                        cur = num[size * i + j];
                        if (prev == cur) {
                            num[size * i + pos] = 2 * prev;
                            score += 2 * prev;
                            pos++;
                            prev = 0;
                            cur = 0;
                        }
                        if (prev != 0) {
                            num[size * i + pos] = prev;
                            pos++;
                            prev = cur;
                            cur = 0;
                        } else {
                            prev = cur;
                        }
                    }
                }
                if (prev) {
                    num[size * i + pos] = prev;
                    pos++;
                }

                for (j = pos; j < size; j++) {
                    num[size * i + j] = 0;
                }
            }

            break;
        case 38:  //up
            for (i = 0; i < size; i++) {
                prev = 0;
                cur = 0;
                pos = 0;
                for (j = 0; j < size; j++) {
                    if (num[size * j + i] != 0) {
                        cur = num[size * j + i];
                        if (prev == cur) {
                            num[size * pos + i] = 2 * prev;
                            score += 2 * prev;
                            pos++;
                            prev = 0;
                            cur = 0;
                        }
                        if (prev != 0) {
                            num[size * pos + i] = prev;
                            pos++;
                            prev = cur;
                            cur = 0;
                        } else {
                            prev = cur;
                        }
                    }
                }
                if (prev) {
                    num[size * pos + i] = prev;
                    pos++;
                }

                for (j = pos; j < size; j++) {
                    num[size * j + i] = 0;
                }
            }

            break;
        case 39:  //right
            for (i = 0; i < size; i++) {
                prev = 0;
                cur = 0;
                pos = size - 1;
                for (j = size - 1; j >= 0; j--) {
                    if (num[size * i + j] != 0) {
                        cur = num[size * i + j];
                        if (prev == cur) {
                            num[size * i + pos] = 2 * prev;
                            score += 2 * prev;
                            pos--;
                            prev = 0;
                            cur = 0;
                        }
                        if (prev != 0) {
                            num[size * i + pos] = prev;
                            pos--;
                            prev = cur;
                            cur = 0;
                        } else {
                            prev = cur;
                        }
                    }
                }
                if (prev) {
                    num[size * i + pos] = prev;
                    pos--;
                }

                for (j = pos; j >= 0; j--) {
                    num[size * i + j] = 0;
                }
            }
            break;
        case 40:  //down
            for (i = 0; i < size; i++) {
                prev = 0;
                cur = 0;
                pos = size - 1;
                for (j = size - 1; j >= 0; j--) {
                    if (num[size * j + i] != 0) {
                        cur = num[size * j + i];
                        if (prev == cur) {
                            num[size * pos + i] = 2 * prev;
                            score += 2 * prev;
                            pos--;
                            prev = 0;
                            cur = 0;
                        }
                        if (prev != 0) {
                            num[size * pos + i] = prev;
                            pos--;
                            prev = cur;
                            cur = 0;
                        } else {
                            prev = cur;
                        }
                    }
                }
                if (prev) {
                    num[size * pos + i] = prev;
                    pos--;
                }

                for (j = pos; j >= 0; j--) {
                    num[size * j + i] = 0;
                }
            }
            break;
    }
}

function fillRandom() {
    empty = new Array();
    total = 0;
    for (i = 0; i < size; i++) {
        for (j = 0; j < size; j++) {
            if (num[4 * i + j] == 0) {
                empty[total] = 4 * i + j;
                total++;
            }
        }
    }
    if (total == 0) {
        var poss = 0;
        for (i = 0; i < size; i++) {
            for (j = 0; j < size - 1; j++) {
                if ((num[size * i + j] == num[size * i + j + 1]) || (num[i + size * j] == num[i + size * j + size])) {
                    poss = 1;
                    break;
                }
            }
            if (poss == 1) break;
        }
        // Game Over
        if (poss == 0) return 1;
    }

    pos = Math.floor(Math.random() * 16);
    pos = pos % total;
    num[empty[pos]] = 2;
    return 0;
}
</script>
</body>
</html>
